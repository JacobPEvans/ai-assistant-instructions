name: Sync Command Symlinks

on:
  push:
    branches: [main]
    paths: ['agentsmd/commands/**']
  workflow_dispatch:

jobs:
  sync-symlinks:
    name: "Sync Command Symlinks"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Sync symlinks
        run: |
          #!/bin/bash
          set -e

          # Create .claude/commands if it doesn't exist
          mkdir -p .claude/commands

          # Create symlinks for all .md files in agentsmd/commands that don't already have symlinks
          # Uses find + xargs instead of for loop per CLAUDE.md rules
          CREATED=$(find agentsmd/commands -maxdepth 1 -name '*.md' -type f -print0 | \
            xargs -0 -I {} sh -c '
              basename=$(basename "{}")
              symlink_path=".claude/commands/$basename"
              target="../../agentsmd/commands/$basename"
              if [ ! -L "$symlink_path" ] && [ ! -f "$symlink_path" ]; then
                ln -s "$target" "$symlink_path"
                echo "Created symlink: $symlink_path -> $target"
              fi
            ' | wc -l | tr -d " ")

          if [ "$CREATED" -gt 0 ]; then
            echo "New symlinks created: $CREATED"
          else
            echo "No new symlinks needed"
          fi

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -n "$(git status --porcelain .claude/commands)" ]; then
            git add .claude/commands
            git commit -m "ci: auto-sync command symlinks"
            git push
          fi
