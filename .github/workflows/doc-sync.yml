name: Documentation Sync

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  doc-sync:
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 1

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - uses: anthropics/claude-code-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          claude_args: |
            --max-turns 5
            --allowedTools "Read,Write,Edit,Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(git status:*),Bash(gh pr:*)"

          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            PR TITLE: ${{ github.event.pull_request.title }}

            Validate and update documentation for this PR:

            ## PLANNING.md Validation
            - Verify ONLY contains incomplete/in-progress tasks
            - Remove any completed tasks (they belong in CHANGELOG.md)
            - If this PR completes a planned task, remove it from PLANNING.md
            - Ensure proper formatting and structure

            ## CHANGELOG.md Validation
            - Add entry for this PR under appropriate section:
              - Added: New features
              - Changed: Updates to existing features
              - Fixed: Bug fixes
              - Removed: Removed features
            - Follow Keep a Changelog format
            - Include PR number reference

            ## General Documentation
            - Verify README.md is accurate if relevant files changed
            - Check CONTRIBUTING.md alignment if workflow files changed
            - Ensure no stale documentation references

            If updates are needed, commit to PR branch with message:
            "docs: validate and sync documentation [skip ci]"

            If no updates needed, post a brief comment confirming docs are in sync.
